# DeepSea 项目 AI 协作开发规则
## LLM Collaboration Protocol v1.4

---

# 一、核心理念

## 1.1 Vibe Development 哲学

> **最珍贵的是对话过程本身，不追求直接出结果，而是步步为营共同规划。**

本项目采用 **Vibe Development** 模式：
- AI 不是执行者，而是**协作伙伴**
- 不急于产出代码，先**对齐理解**
- 每个决策都是**共同思考**的结果
- 对话本身就是**设计过程**的一部分

## 1.2 决策质量观

> **300+ 决策，90% 正确率，关键决策零失误**

游戏开发是一系列决策的集合：
- 只有做对 90% 以上的决策，游戏才有望完成
- 关键决策一个不能错，否则可能导致项目失败
- 因此每个 S/A 级决策都需要 **人机共同 Review**

## 1.3 长期对话工程观

这是一个**长期对话工程**，不是一次性任务：
- 对话是连续的，上下文需要被**持久化保存**
- 每次对话都在前次基础上**迭代推进**
- Git 提交历史记录了**思维演进过程**
- CONTRIBUTING_AI.md 是**活文档**，随项目成长

---

# 二、职能角色定义

本项目模拟多职能协作，AI 在对话中切换不同角色视角：

| 角色代号 | 职能 | 关注点 | 触发词 |
|---------|------|--------|--------|
| `[DESIGN]` | 游戏策划 | 玩法、体验、平衡、叙事 | "策划"、"设计"、"玩法" |
| `[ARCH]` | 架构程序 | 底层结构、性能、可扩展性 | "架构"、"底层"、"重构" |
| `[DEV]` | 功能开发 | 具体实现、Bug修复 | "开发"、"实现"、"代码" |
| `[ART]` | 美术指导 | 风格、资产规范、视觉反馈 | "美术"、"视觉"、"风格" |
| `[PM]` | 项目管理 | 里程碑、优先级、进度 | "规划"、"排期"、"优先级" |
| `[QA]` | 质量保证 | 测试、验证、边界情况 | "测试"、"验证"、"Bug" |

**使用方式**: 在对话中明确指定角色，或让 AI 自动识别并标注当前角色视角。

## 2.2 QA 角色的特殊地位

> **QA 是每个功能的最后守门人，无验收则不算完成**

QA 职能贯穿整个开发流程：
- **开发前**: 参与需求评审，提出测试视角问题
- **开发中**: 准备测试用例框架
- **开发后**: 执行验收测试，确认功能符合预期
- **持续**: 维护 `docs/QA_TEST_CASES.md` 测试手册

---

# 三、决策分级制度

## 3.1 决策等级

| 等级 | 类型 | 影响范围 | Review 要求 |
|-----|------|---------|------------|
| **S** | 战略决策 | 整体方向、核心玩法 | 必须人工确认，记录决策理由 |
| **A** | 架构决策 | 系统设计、数据结构 | 人工Review，可异步确认 |
| **B** | 实现决策 | 具体方案选择 | AI 提出建议，人工可快速确认或默认通过 |
| **C** | 细节决策 | 参数、命名、格式 | AI 自主决策，事后可调整 |

## 3.2 决策记录格式

```markdown
## DECISION-{序号}: {标题}
- **等级**: S/A/B/C
- **角色**: [DESIGN]/[ARCH]/[DEV]/[ART]/[PM]/[QA]
- **问题**: {需要决策的问题}
- **选项**: 
  - A: {选项A}
  - B: {选项B}
- **决策**: {最终选择}
- **理由**: {为什么这么选}
- **日期**: {YYYY-MM-DD}
- **状态**: PENDING / CONFIRMED / REVISED
```

---

# 四、开发流程协议

## 4.1 任务单元定义

开发不按日期，按 **对话任务单元** 推进：

```
任务单元 (Task Unit):
├── ID: TASK-{职能}-{序号}
├── 职能: DESIGN / ARCH / DEV / ART / PM / QA
├── 特性: {关联的功能模块}
├── 前置: {依赖的任务}
├── 产出: {预期输出}
├── 状态: TODO / IN_PROGRESS / REVIEW / DONE
└── 对话轮次: {完成所需的预估对话轮数}
```

## 4.2 标准对话流程

### 4.2.0 对话开始时（强制）

> **每次新对话开始，AI 必须先读取 `docs/CONTEXT.md` 恢复当前状态**

```
1. 读取 docs/CONTEXT.md → 了解当前进度
2. 读取 CONTRIBUTING_AI.md → 了解协作规则（如未加载）
3. 确认用户本次对话目标
4. 开始工作
```

### 4.2.1 对话结束时（强制）

> **每次对话结束前，AI 必须更新 `docs/CONTEXT.md` 保存当前状态**

```
1. 更新 docs/CONTEXT.md → 保存进度
2. 更新 docs/CHANGELOG.md → 记录本次产出
3. 如有新决策 → 更新 docs/DECISIONS.md
4. Git commit → 记录对话成果
```

### 4.2.2 标准对话中流程

```
1. [人] 提出需求/问题
       ↓
2. [AI] 识别角色，分析问题
       ↓
3. [AI] 如果是 S/A 级决策 → 列出选项，请求确认
   如果是 B/C 级决策 → 给出建议并执行
       ↓
4. [AI] 执行任务，输出结果
       ↓
5. [AI] 如果是功能开发 → 更新 QA 测试用例 ← 重要！
       ↓
6. [AI] 总结本轮进展，提示下一步
       ↓
7. [人] 确认/修正/继续
       ↓
8. [AI] Git 提交，记录本轮产出  ← 重要！
```

## 4.3 迭代建议管理协议（重要）

> **QA 测试中产生的迭代建议，必须经过 PM 评审后决定是否纳入当前里程碑**

**迭代建议来源**:
- QA 测试过程中的体验反馈
- 开发过程中发现的改进点
- 用户/人类的直接建议

**PM 评审流程**:
```
1. 收集 → 记录到 docs/ROADMAP.md "迭代建议池"
2. 评审 → 分析优先级、冲突、成本
3. 决策 → 纳入/延后/拒绝
4. 排期 → 确定开发顺序
5. 执行 → 转为 TASK
```

**评审维度**:
- 与当前任务的依赖/冲突关系
- 对用户体验的影响程度
- 开发成本和技术复杂度
- 里程碑剩余时间约束

**决策分类**:
- ✅ 纳入当前里程碑
- ⏳ 延后到下个里程碑
- ❌ 拒绝（不符合方向）
- 🔄 合并其他迭代

**关键文件**: `docs/ROADMAP.md`

---

## 4.4 版本回顾协议（重要）

> **每次新版本规划前，必须回顾上个版本的测试表现和用户反馈**

**回顾时机**: 里程碑验收完成后，开始下一阶段规划前

**回顾内容**:
```
1. 测试表现
   - 通过率、问题分布
   - 稳定性评估
   
2. 用户体验反馈
   - 核心循环验证结果
   - 操作手感、视觉体验
   - 系统性缺失 (如地形、生态)
   
3. 技术债务
   - 已知问题表
   - 性能瓶颈
   
4. 迭代建议池
   - 上版本积累的建议
   - 优先级重新评估
```

**产出**:
- 补充新的设计需求到下一阶段
- 调整任务优先级
- 记录设计决策

**关键原则**:
- 不只是"加新功能"，也要"完善已有系统"
- 版本间要有连贯的体验进化
- 用户反馈优先于原计划

---

## 4.5 构建打包协议（重要）

> **全量验收前必须完成打包流程，打包是开发的一环**

**构建时机**:
- ✅ 里程碑全量验收前
- ✅ Bug 修复期集中测试
- ✅ 准备分发/演示版本
- ❌ 不需要每次提交都构建

**全量验收前 CheckList**:
```
[ ] 1. npm run build
[ ] 2. 双击 dist/index.html 测试
[ ] 3. 确认游戏正常运行
[ ] 4. 更新 操作说明.txt (如有新功能)
```

**关键文件**: `docs/CICD.md`

---

## 4.6 配置级迭代协议（重要）

> **仅修改数值配置、不改动代码逻辑的迭代，可快速执行**

**定义**:
配置级迭代 = 仅调整现有参数值，不增删代码逻辑

**可快速执行的配置示例**:
- 移动速度、视角灵敏度
- 光照强度、雾气密度、颜色值
- 生命值、氧气消耗、伤害数值
- 地形高度、噪声频率、区域边界
- UI 位置、字体大小、透明度

**执行规则**:
1. 用户明确指出"配置调整"或"数值修改"
2. AI 直接修改对应配置值
3. 无需 PM 审批，无需创建 TASK
4. commit 使用 `[CONFIG]` 前缀

**不适用情况** (需 PM 审核排期):
- 需要新增函数/类/文件
- 涉及系统交互逻辑变更
- 可能影响其他模块
- 用户不确定该改什么

---

## 4.7 QA 验收协议（重要）

> **每个功能完成后，必须同步更新 QA 测试用例，供验收使用**

**QA 测试用例要素**:
- 测试 ID (TC-{模块}-{序号})
- 关联功能 (TASK-ID)
- 前置条件
- 测试步骤 (可复现的操作序列)
- 预期结果 (明确、可验证)
- 测试状态

**开发者责任**:
1. 功能完成时，在 `docs/QA_TEST_CASES.md` 添加测试用例
2. 提供清晰的操作步骤和预期表现
3. 标注已知限制或边界情况

**QA 责任**:
1. 按测试用例执行验收测试
2. 记录实际结果和问题
3. 更新测试状态 (通过/部分通过/未通过)
4. **验收失败时**: 附上浏览器控制台日志 (F12)
5. 提交 Bug 到已知问题表

**调试日志规范**:
- `[DEBUG]` 临时调试日志，问题解决后移除
- `[LOG]` 持久日志，用于生产问题定位
- 关键交互流程应有日志埋点覆盖
- 后续考虑: 日志收集/上报系统 (Phase 2+)

## 4.2.3 快速验收回复模板

功能开发完成后，AI 必须提供**快速验收清单**，用户可直接复制回复：

```markdown
## 🧪 快速验收

**启动**: `npm run dev` → http://localhost:3000

**验收项**:
- [ ] 功能A: {操作} → {预期}
- [ ] 功能B: {操作} → {预期}
- [ ] 功能C: {操作} → {预期}

**快速回复** (复制修改后发送):
✅ 全部通过
或
⚠️ 问题: {描述问题}
```

**用户回复格式**:
- `✅` 或 `通过` - 全部验收通过，继续下一步
- `⚠️ 问题: xxx` - 有问题需要修复
- `跳过` - 暂不验收，先继续

## 4.2.4 GM 测试规范（重要）

> **开发完成后，AI 必须提供 GM 快捷测试方法，加速验收**

本项目内置 GM 控制台 (按 `/` 打开)，支持快速测试：

**常用 GM 命令**:
```
god               - 切换无敌模式 (不消耗氧气、不受伤)
tp {x} {y} {z}    - 传送到指定位置
give {物品ID} {数量} - 给予物品
clear             - 清空背包
refill            - 补满氧气和生命
```

**AI 提供验收时的 GM 测试方案模板**:
```markdown
## 🎮 GM 快速测试

**测试目标**: {功能名称}

**GM 快捷步骤**:
1. 按 `/` 打开控制台
2. 输入: `{GM命令}`
3. {后续操作}
4. 预期: {预期效果}

**示例命令组合**:
- 测试深海功能: `god` → `tp 0 -100 0`
- 测试制造系统: `give stone 10` → `give iron 5`
- 测试战斗系统: `give knife 1` → 攻击生物
```

**GM 测试原则**:
- 优先使用 GM 跳过非目标流程 (如用 `tp` 直达测试区域)
- 用 `god` 排除生存压力干扰
- 用 `give` 快速获取测试所需物品
- 测试完成后关闭 `god` 验证正常流程

## 4.3 Git 协作规范

### 分支策略
```
main                 # 稳定版本
├── dev              # 开发主线
│   ├── feature/{特性名}     # 功能开发
│   ├── design/{设计文档}    # 策划迭代
│   ├── refactor/{模块名}    # 重构优化
│   └── fix/{问题描述}       # Bug修复
```

### Commit 前缀
```
[DESIGN]  策划文档变更
[ARCH]    架构调整
[FEAT]    新功能
[FIX]     Bug修复
[CONFIG]  配置数值调整 (不改逻辑)
[REFACTOR] 重构
[ART]     美术资源
[DOC]     文档更新
[TEST]    测试相关
[VIBE]    对话/规则/协作流程更新
```

### Issue 模板
```markdown
## Issue 类型: BUG / FEATURE / DESIGN / QUESTION

### 描述
{问题或需求描述}

### 关联任务
TASK-{ID}

### 决策等级
S / A / B / C

### 期望结果
{预期的解决方案或产出}
```

## 4.4 Git 工作流协议（重要）

### 核心原则
> **每次有效对话都必须产生 Git 提交，记录思维演进**

Git 历史不仅是代码版本，更是**设计思维的演进记录**：
- 每个 commit 代表一次有效的人机协作产出
- commit message 记录了"做了什么"和"为什么"
- 未来可以通过 git log 回溯设计决策过程

### 每次对话结束时的 Git 操作（必须）
```bash
1. git add -A                    # 暂存所有变更
2. git status                    # 确认变更内容
3. git commit -m "[前缀] 描述"   # 提交到本地 ← 必须！
4. (可选) git push               # 推送到远程 (需用户确认)
```

### Commit Message 格式
```
[前缀] 简短描述 (50字符内)

- 详细变更点1
- 详细变更点2
- 关联决策: DECISION-XXX (如有)
- 对话主题: {本次对话的核心议题}
```

### 里程碑 Tag
```bash
git tag -a v0.1.0 -m "Phase 1: 核心原型完成"
```

### 本地分支使用时机
- **master**: 稳定的对话产出
- **feature/xxx**: 实验性功能 (需要多轮对话验证)
- **design/xxx**: 策划迭代 (大改动前创建)

---

# 五、上下文管理

## 5.1 关键文件职责

| 文件 | 职责 | 更新时机 |
|-----|------|---------|
| `CONTRIBUTING_AI.md` | AI 协作规则，顶层指导，Vibe 哲学 | 协作方式演进时 |
| `docs/GDD_*.md` | 策划设计文档 | 设计迭代时 |
| `docs/DECISIONS.md` | 重要决策记录 | 每次 S/A 级决策后 |
| `docs/CHANGELOG.md` | 版本变更日志 | 每次有效对话后 |
| `docs/CONTEXT.md` | 当前开发上下文 | 每次对话结束时 |
| `docs/QA_TEST_CASES.md` | **QA 测试用例手册** | **每个功能完成时** |
| `docs/ROADMAP.md` | **路线图+迭代建议** | **里程碑规划/QA反馈时** |
| `docs/CICD.md` | **构建打包指南** | **打包流程变更时** |
| `README.md` | 项目概览 | 里程碑完成时 |
| `.cursor/rules/*.md` | AI 开发技能规则 | 积累最佳实践时 |

## 5.2 上下文恢复协议

当开启新对话时，AI 应：
1. 读取 `CONTRIBUTING_AI.md` 了解协作规则和 Vibe 哲学
2. 读取 `docs/CONTEXT.md` 恢复当前状态
3. 读取 `docs/DECISIONS.md` 了解已确认和待定决策
4. 运行 `git log --oneline -10` 了解最近进展
5. 询问用户本次对话目标

## 5.3 上下文保存协议

每次对话结束时，AI 应：
1. 更新 `docs/CONTEXT.md` 保存当前状态
2. 更新 `docs/CHANGELOG.md` 记录本次产出
3. 如有新决策，更新 `docs/DECISIONS.md`
4. 如有协作方式改进，更新 `CONTRIBUTING_AI.md`
5. **必须执行 git commit** 记录本次对话产出

---

# 六、Prompt 工程最佳实践

## 6.1 有效提问模板

### 策划讨论
```
[DESIGN] 我想讨论{系统名称}的设计
当前想法是: {描述}
主要顾虑: {顾虑}
请从玩家体验角度分析
```

### 技术方案
```
[ARCH] 我需要设计{模块名}的架构
需求: {功能需求}
约束: {性能/兼容性约束}
请给出2-3个方案对比
```

### 具体实现
```
[DEV] 请实现{功能}
输入: {输入描述}
输出: {期望输出}
相关文件: {文件路径}
```

### 问题诊断
```
[QA] 遇到问题: {问题描述}
复现步骤: {步骤}
期望行为: {期望}
实际行为: {实际}
```

## 6.2 高价值引导词

| 场景 | 引导词 |
|-----|-------|
| 深入分析 | "请从{角色}视角分析"、"有哪些我没考虑到的" |
| 方案对比 | "给出2-3个方案并对比优劣" |
| 风险评估 | "这个方案最大的风险是什么" |
| 简化问题 | "MVP版本最少需要什么" |
| 扩展思考 | "如果未来要支持{X}，现在要预留什么" |
| 经验借鉴 | "类似游戏是怎么处理这个问题的" |
| Vibe 对齐 | "你理解我的意图了吗"、"我们先对齐一下理解" |

## 6.3 Vibe Development 沟通技巧

### 不要说
- "帮我写一个XXX" (太直接，跳过思考)
- "直接给我代码" (跳过设计讨论)

### 推荐说
- "我想和你讨论一下XXX的设计"
- "你觉得这个方案有什么问题"
- "我们先对齐一下理解，再动手"
- "这个决策你怎么看"
- "把你的思考过程告诉我"

---

# 七、已确认决策汇总

## Phase 0 决策 (2026-01-19)

| ID | 决策 | 选择 | 理由 |
|----|------|------|------|
| 001 | 地图规模 | 500×500 | 先验证核心循环，后期可扩展 |
| 002 | 技术框架 | Three.js + TS + Vite | WebGL封装成熟，3D能力强 |
| 003 | 生存系统 | 氧气 + 生命值 | 简化但保留核心紧迫感 |
| 004 | 视角模式 | 第一人称 | 深海沉浸感最佳 |
| 005 | 死亡惩罚 | 基地复活 + 保留物品 | 中等惩罚，预留难度扩展 |
| 006 | 存档策略 | 手动存档 | 增加决策权重感 |
| 007 | 内容架构 | 解耦内容层 | 支持更换叙事主题 |

---

# 八、里程碑定义

## 8.1 里程碑规范

> **里程碑 = 大量特性 + Bug修复期 + 全量验收**

一个里程碑应该包含：
- **多个重大特性** (不是单次小修改)
- **完整的功能闭环** (可独立体验的版本)
- **Bug 修复期** (特性冻结，专注修复)
- **全量 QA 验收** (所有测试用例通过)

### 里程碑生命周期

```
┌─────────────────────────────────────────────────────────┐
│                   里程碑生命周期                          │
├─────────────────────────────────────────────────────────┤
│  1. 特性开发期                                           │
│     ├── 开发特性 A → 快速验收 → 通过                     │
│     ├── 开发特性 B → 快速验收 → 通过                     │
│     ├── 开发特性 C → 快速验收 → 通过                     │
│     └── ... (持续迭代)                                   │
├─────────────────────────────────────────────────────────┤
│  2. 特性冻结 (Feature Freeze)                           │
│     ├── 不再添加新功能，只修 Bug                         │
│     └── 执行 npm run build 打包                         │
├─────────────────────────────────────────────────────────┤
│  3. Bug 修复期 (集中构建测试)                            │
│     ├── 在 dist/ 打包版本上测试                         │
│     ├── QA 全量测试，提交问题                            │
│     ├── 开发修复 Bug → 重新 build                       │
│     └── 循环直到问题清零                                 │
├─────────────────────────────────────────────────────────┤
│  4. 里程碑验收                                           │
│     ├── QA_TEST_CASES.md 全部 🟢                        │
│     ├── 已知问题表清零或标记为"延后"                     │
│     ├── 更新 操作说明.txt                               │
│     └── git tag vX.X.0                                  │
├─────────────────────────────────────────────────────────┤
│  5. 版本回顾 (4.4 版本回顾协议)                         │
│     ├── 回顾测试表现和用户反馈                          │
│     ├── 识别体验缺失和改进点                            │
│     └── 补充新需求到下一阶段                            │
├─────────────────────────────────────────────────────────┤
│  6. 进入下一里程碑                                       │
└─────────────────────────────────────────────────────────┘
```

### Bug 修复期规则

- **特性冻结**: 不接受新功能需求
- **敏捷修复**: QA 随时提问题，开发快速响应
- **优先级**: P0(崩溃) > P1(功能异常) > P2(体验问题) > P3(优化建议)
- **延后处理**: 非关键问题可标记"延后到下个里程碑"

## 8.2 里程碑规划位置

> **里程碑详细规划请查看**: `docs/ROADMAP.md`
> **当前进度请查看**: `docs/CONTEXT.md`

本文件 (CONTRIBUTING_AI.md) 只定义规则和流程，不维护具体进度状态。

---

# 九、本文档迭代日志

| 版本 | 日期 | 变更内容 |
|-----|------|---------|
| v1.0 | 2026-01-19 | 初始版本，建立基础协作框架 |
| v1.1 | 2026-01-19 | 加入 Vibe Development 哲学，强调对话过程价值，明确 Git 提交要求 |
| v1.2 | 2026-01-19 | 强化 QA 验收流程，新增 QA_TEST_CASES.md，功能完成必须同步更新测试用例 |
| v1.3 | 2026-01-19 | 完善里程碑规范：特性开发期 → Bug修复期 → 全量验收 → 下一里程碑 |
| v1.4 | 2026-01-19 | **重要**: 强制CONTEXT.md更新协议 (4.2.0/4.2.1)，里程碑规划移至ROADMAP.md |
| v1.5 | 2026-01-19 | 新增构建打包协议 (4.4)，创建CICD.md，全量验收前必须完成打包 |
| v1.6 | 2026-01-19 | **重要**: 新增版本回顾协议 (4.4)，里程碑生命周期增加回顾环节 |
| v1.7 | 2026-01-19 | 新增 GM 测试规范 (4.2.4)，验收时必须提供 GM 快捷测试方案 |

---

# 十、快速参考

## 开始新对话时说

```
继续 DeepSea 项目开发。
请先读取 CONTRIBUTING_AI.md 和 docs/CONTEXT.md 恢复上下文。
本次对话目标: {你的目标}
```

## 结束对话前说

```
请更新 docs/CONTEXT.md 保存当前进度。
总结本次对话的决策和产出。
然后 git commit 记录本次对话。
```

## Vibe Check

```
在继续之前，确认一下：
- 我们对齐理解了吗？
- 这个方向对吗？
- 有什么我没考虑到的？
```

---

# 十一、Git 提交历史参考

本项目的 Git 历史记录了完整的设计演进过程：

```bash
# 查看提交历史
git log --oneline

# 查看某次提交详情
git show <commit-hash>

# 查看文件变更历史
git log --follow -p <file>
```

**当前提交历史:**
```
56dfd74 [DESIGN] 确认7个核心决策 - 技术选型与内容架构定型
0f443ff [DOC] 补充 Git 工作流协议
10828c8 [DOC] Phase 0: 项目初始化 - 策划白皮书与AI协作框架建立
```

---

*本文档是活文档，记录人机协作的演进过程。*
*最珍贵的不是结果，而是我们共同思考的旅程。*
